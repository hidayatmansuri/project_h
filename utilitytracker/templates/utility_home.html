{% extends "home.html" %}
{% load static %}

{% block title %}Utility Tracker{% endblock %}

{% block content %}
<div class="utility-container home-body">
  <!-- layout: content area (left) and forms (right on desktop / top on mobile) -->
  <div class="utility-left">
    <div class="ph-heading">Daily Usage Graphs</div>

    <div class="graph-controls">
      <label><input type="radio" name="viewMode" value="daily" checked> Daily</label>
      <label><input type="radio" name="viewMode" value="monthly"> Monthly</label>
      <label><input type="radio" name="viewMode" value="yearly"> Yearly</label>
      <label><input type="checkbox" id="showBalance"> Show Balance</label>
    </div>

    <canvas id="consumptionChart" height="180"></canvas>
    <canvas id="balanceChart" height="120" style="display:none; margin-top:1rem;"></canvas>
    <br>
    <div class="ph-line"></div>
    <div class="ph-heading">Last 30 days</div>
    <table class="ph-table">
      <thead><tr><th>Date</th><th>Electricity</th><th>Gas</th></tr></thead>
      <tbody>
      {% for r in last_30_rows %}
        <tr><td>{{ r.date }}</td><td>£{{ r.electricity|floatformat:2 }}</td><td>£{{ r.gas|floatformat:2 }}</td></tr>
      {% empty %}
        <tr><td colspan="3">No readings yet</td></tr>
      {% endfor %}
      </tbody>
      <tr>
      {% for d in last_30_dates %}
        <th>{{ d }}</th>
      {% endfor %}
      </tr>
    </table>
  </div>

  <div class="utility-right">
    <div class="ph-form">
      <div class="ph-heading">Today's Reading</div>
      <form method="POST">
        {% csrf_token %}
        <div class="ph-label">{{ reading_form.electricity.label_tag }}</div><br>
        <div class="ph-space">{{ reading_form.electricity }}</div><br>
        <div class="ph-label">{{ reading_form.gas.label_tag }}</div><br>
        <div class="ph-space">{{ reading_form.gas }}</div><br>
        <button class="ph-button" name="submit_reading" type="submit">Submit</button>
      </form>
    </div>
    <div class="ph-line"></div>
    <div class="ph-form">
      <div class="ph-heading">Top-up (Pre-pay)</div>
      <form method="POST">
        {% csrf_token %}
        <div class="ph-label">{{ topup_form.meter.label_tag }}</div><br>
        <div class="ph-space">{{ topup_form.meter }}</div><br>
        <div class="ph-label">{{ topup_form.amount.label_tag }}</div><br>
        <div class="ph-space">{{ topup_form.amount }}</div><br>
        <div class="ph-label">{{ topup_form.note.label_tag }}</div><br>
        <div class="ph-space">{{ topup_form.note }}</div><br>
        <button class="ph-button" name="submit_topup" type="submit">Top-up</button>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block script %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    window.chartPayload = {{ chart_payload|safe }};
  </script>
  <script src="{% static 'js/utility-chart.js' %}"></script>
{% endblock %}